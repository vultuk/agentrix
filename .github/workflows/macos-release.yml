name: macOS Release

on:
  push:
    tags:
      - "v*"
      - "mac-*"
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag to use for the release (e.g., v1.0.0-mac)"
        required: true
      release_name:
        description: "Optional release title (defaults to the tag)"
        required: false

jobs:
  build-and-release:
    runs-on: macos-latest
    env:
      MACOS_PROJECT_DIR: mobile/ios
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine release metadata
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ github.event.inputs.tag_name }}"
            NAME="${{ github.event.inputs.release_name }}"
            if [[ -z "$NAME" ]]; then
              NAME="$TAG"
            fi
          else
            TAG="${GITHUB_REF##*/}"
            NAME="Agentrix macOS ${TAG}"
          fi
          echo "RELEASE_TAG=$TAG" >> "$GITHUB_ENV"
          echo "RELEASE_NAME=$NAME" >> "$GITHUB_ENV"

      - name: Build macOS app
        run: ./scripts/build-macos-app.sh

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: AgentrixMobile-macOS
          path: ${{ env.MAC_APP_ZIP }}

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: ${{ env.RELEASE_NAME }}
          files: ${{ env.MAC_APP_ZIP }}
